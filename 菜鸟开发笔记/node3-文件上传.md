
# 文件上传

## 上传路径：
```plaintext
客户端 ──Nginx（轮询）──▶ MinIO节点1（存储分片1）
          │                ├─ MinIO节点2（存储分片2）
          └─COS直接上传───▶ 腾讯云 COS 服务
          │                ├─ MinIO节点3（存储校验1）
          └─本地存储──────▶ 本地磁盘
```


* 本地保存：只需要保存到服务器磁盘（慎用）
* COS保存：
    * COS路径格式：/cos/{FileSha1}/{FileName}

* MinIO保存：
    * MinIO路径格式：/minio/{FileSha1}/{FileName}

## 分块上传

### 流程
1. api发送分块上传请求，传入文件的sha1值和文件大小
2. rpc生成分块上传的初始化信息，api得到uploadID、分块大小、分块数量信息，rpc服务端会将这些信息写入redis
3. api返回初始化信息给前端，等待前端上传分块
4. 前端上传分块文件：将文件分割成小文件，每个文件对应有index，通过api上传，api检查该index是否已经上传or没有上传
5. 全部上传结束，调用文件分块合并：检查分块完整性、合并
6. 判断文件保存方法：本地、cos、minio，调用对应rpc接口


## 文件秒传

即查询数据库中文件sha1值是否存在，存在则直接建立文件元数据关系



