# 批处理


## 核心目标：
> 将高频次的小规模操作（如单个文件元数据写入数据库）聚合为低频次的大规模操作，通过减少 I/O 交互次数（如数据库写入、网络请求）提升系统吞吐量，降低资源消耗；本项目主要为了减少数据库io，相当于一次insert多条数据

## 怎么实现：

开源代码阅读：


## 核心机制：
0. 生产者消费者模型
* Add 生产者：负责将新的文件元数据push到channel中
* Merge消费者：阻塞等待channel，将文件元数据交给自定函数Do处理，（这里Do函数为回调函数，实现为交给kafka'）

1. 分片Sharding
* 将不同 user_id 的数据分配到不同的工作协程，避免竞争，实现并行处理
* 每个 user_id 对应一个分片，确保同一用户的文件元数据由固定协程处理（避免乱序），取模后存入对应协程

2. 双通道触发
* 单个协程累积 100 条数据时，立即批量处理
* 无论数据量多少，每隔 1 秒强制批量处理

3. 并行处理


